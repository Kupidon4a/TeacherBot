version: "3.9"

services:
  mongo:
    image: mongo:6.0
    container_name: mongodb
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db

  mongo-seed:
    image: mongo:6.0
    depends_on:
      - mongo
    volumes:
      - ./test_data:/test_data
    entrypoint: >
      bash -c '
        echo "‚è≥ –ñ–¥—ë–º –∑–∞–ø—É—Å–∫–∞ MongoDB..." &&
        sleep 5 &&
        echo "üì• –ò–º–ø–æ—Ä—Ç JSON –≤ –±–∞–∑—É teacherbot..." &&
        echo "üìÇ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ /test_data:" &&
        ls -l /test_data &&
        for file in /test_data/*.json; do
          echo "‚ñ∂ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ñ–∞–π–ª: $$file"
          name=$$(basename "$$file")
          name="$${name##teacherbot.}"
          name="$${name%.json}"
          echo "üìÑ –ò–º–ø–æ—Ä—Ç –∫–æ–ª–ª–µ–∫—Ü–∏–∏: $$name"
          mongoimport --host mongo --db teacherbot --collection "$$name" --file "$$file" --jsonArray
        done &&
        echo "‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω."
      '

  bot:
    build: .
    container_name: telegram-bot
    depends_on:
      - mongo

    environment:
      - MONGO_URI=mongodb://mongo:27017
    restart: unless-stopped

volumes:
  mongo_data: